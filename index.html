<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Constrution Fleet Planing App</title>
    <!-- Bootstrap CSS -->
    <!-- <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
      crossorigin="anonymous"
    /> -->

    <link
      href="https://api.tomtom.com/maps-sdk-for-web/cdn/6.x/6.15.0/maps/maps.css"
      rel="stylesheet"
      type="text/css"
    />
    <link rel="stylesheet" href="./styles.css" />
    <script src="https://api.tomtom.com/maps-sdk-for-web/cdn/6.x/6.15.0/maps/maps-web.min.js"></script>
    <script src="https://api.tomtom.com/maps-sdk-for-web/cdn/6.x/6.15.0/services/services-web.min.js"></script>
  </head>

  <body>
    <div class="container d-flex">
      <div class="control-panel">
        <h2 class="control-panel__title">Constrution Fleet Planing App</h2>
        <form class="control-panel__controls overflow-auto shadow">
          <fieldset>
            <label for="start-address" class="">Start Address:</label
            ><input
              type="text"
              class=""
              placeholder="san diego"
              id="start-address"
            />
          </fieldset>
          <fieldset>
            <label for="end-address" class="">End Address:</label
            ><input
              type="text"
              class=""
              placeholder="lily avenue"
              id="end-address"
            />
          </fieldset>
          <fieldset>
            <label for="arrival-time" class="">Estimated Arrival Time:</label>
            <input type="time" placeholder="Eg: 8:00" id="arrival-time" />
          </fieldset>

          <h3 class=""></h3>

          <fieldset>
            <label for="explosives-present"
              >Vehicle is carrying explosives:</label
            >
            <input
              type="checkbox"
              id="explosives-present"
              value="USHazmatClass1"
            />
          </fieldset>
          <fieldset>
            <label for="gas-present">Vehicle is carrying compressed gas:</label>
            <input type="checkbox" id="gas-present" value="USHazmatClass2" />
          </fieldset>
          <fieldset>
            <label for="is-truck">Vehicle is a truck:</label>
            <input type="checkbox" id="is-truck" value="truck" />
          </fieldset>

          <button class="control-panel__btn">Track</button>
        </form>
      </div>
      <div id="map" class="map"></div>
    </div>

    <!-- <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
      crossorigin="anonymous"
    ></script> -->

    <!-- <script src="./index.js" type="module" ></script> -->
    <script>
      // const API_KEY = "gBuQtiHC80qAV541N23tKQYRUtZbAKIH";
      const API_KEY = "Vn26cA8knt2E8sl0WBEWvAgWGRUf59mm";
      const AMSTERDAM = { lon: 4.8786, lat: 52.3679 };

      var map = tt.map({
        key: API_KEY,
        container: "map",
        // center: {lon: -121.867905, lat: 37.279518},
        center: AMSTERDAM,
        zoom: 10,
      });

      map.addControl(new tt.FullscreenControl());
      map.addControl(new tt.NavigationControl());

      // var requestOptions = {
      //   method: "POST",
      //   headers: { "Content-Type": "application/json" },
      //   body: JSON.stringify({
      //     name: "Construction Site 1",
      //     type: "Feature",
      //     geometry: {
      //       radius: 80,
      //       type: "Point",
      //       shapeType: "Circle",
      //       coordinates: [AMSTERDAM],
      //     },
      //     properties: {
      //       maxSpeedKmh: 70,
      //     },
      //   }),
      //   redirect: "follow",
      // };

      // fetch(
      //   "https://api.tomtom.com/geofencing/1/projects/85f9788d-eb57-4843-9961-13c3e7dddb14/?adminKey=8QfxMVRZI6hkZjSRLeobFHEjsCMYlcnHLjQUR826aPXTaoMt&key=gBuQtiHC80qAV541N23tKQYRUtZbAKIH",
      //   requestOptions
      // )
      //   .then((response) => response.text())
      //   .then((result) => console.log(result))
      //   .catch((error) => console.log("error", error));

      // moves the map to a lnglat cordinates
      function moveMapTo(lnglat) {
        map.flyTo({
          center: lnglat,
          zoom: 13,
        });
      }

      // logs to the console
      function callbackFn(result) {
        console.log(result);
      }

      //markers array
      const markers = [];
      // add marker
      function addMarker(lnglat) {
        const marker = new tt.Marker().setLngLat(lnglat).addTo(map);
        markers.push(marker.getLngLat());
        console.log(markers);
        // return marker.getLngLat();
      }

      map.on("click", (e) => {
        addMarker(e.lngLat);
      });

      //calculate the route between haarlem and amsterdam with the TomTom Maps SDK for web Routing API CalculateRoute
      // function calculateRoute() {
      //   const startAddress = document.getElementById("start-address").value;
      //   const endAddress = document.getElementById("end-address").value;
      //   const arrivalTime = document.getElementById("arrival-time").value;

      //   // const startAddress = "san diego";
      //   // const endAddress = "lily avenue";
      //   // const arrivalTime = "8:00";

      //   const requestOptions = {
      //     method: "POST",
      //     headers: { "Content-Type": "application/json" },
      //     body: JSON.stringify({
      //       start: {
      //         address: startAddress,
      //       },
      //       end: {
      //         address: endAddress,
      //       },
      //       arrival: {
      //         time: arrivalTime,
      //       },
      //     }),
      //     redirect: "follow",
      //   };

      //   fetch(
      //     "https://api.tomtom.com/routing/1/calculateRoute/4.8786,52.3679:4.8786,52.3679/json?key=gBuQtiHC80qAV541N23tKQYRUtZbAKIH",
      //     requestOptions
      //   )
      //     .then((response) => response.json())
      //     .then((result) => {
      //       console.log(result);
      //       const route = result.routes[0];
      //       const routeGeometry = route.geometry;
      //       const routeCoordinates = routeGeometry.coordinates;
      //       const routeLine = new tt.LineString(routeCoordinates);
      //       const routeLineLayer = new tt.LineLayer({
      //         data: routeLine,
      //         width: 3,
      //         color: "#007cbf",
      //       }).addTo(map);
      //       map.fitBounds(routeLineLayer.getBounds());
      //     });
      // }

      // get the lnglat cordinates of an address
      function getAddress(searchValue) {
        tt.services
          .fuzzySearch({
            key: API_KEY,
            query: searchValue,
            lon: 4.8786,
            lat: 52.3679,
          })
          .then((cordinates) => {
            // console.log(cordinates);
            // moveMapTo(cordinates.results[0].position);

            // add marker
            addMarker(cordinates.results[0].position);
            console.log(cordinates.results[0].position);
            // console.log(lnglat);
            // return lnglat
          });
      }

      const location = `${markers[0].lng}, ${markers[0].lng}: ${markers[1].lng}, ${markers[1].lng}`;
      console.log(location);

      // generate route
      function getRoute() {
        const routeOptions = {
          key: API_KEY,
          locations: location,
          // arriveAt: document.getElementById("arrival-time").value,
          travelMode: document.getElementById("is-truck").value,
          // vehicleLoadType: [ document.getElementById("gas-present").value, document.getElementById("explosives-present").value],
          vehicleCommercial: true,
        };

        tt.services.calculateRoute(routeOptions).then(function (response) {
          console.log(response.toGeoJson());
          console.log(response);
          // var geojson = response.toGeoJson();
          // map.addLayer({
          //   id: "route",
          //   type: "line",
          //   source: {
          //     type: "geojson",
          //     data: geojson,
          //   },
          //   paint: {
          //     "line-color": "#4a90e2",
          //     "line-width": 8,
          //   },
          // });

          // var bounds = new tt.LngLatBounds();
          // geojson.features[0].geometry.coordinates.forEach(function (point) {
          //   bounds.extend(tt.LngLat.convert(point)); // creates a bounding area
          // });
          // map.fitBounds(bounds, {
          //   duration: 200,
          //   padding: 50,
          //   maxZoom: 13,
          // }); // zooms the map to the searched route
        });
      }

      document
        .querySelector(".control-panel__btn")
        .addEventListener("click", function (e) {
          e.preventDefault();

          Promise.all([
            getAddress(document.getElementById("start-address").value),
            getAddress(document.getElementById("end-address").value),
          ])
            .then(() => {
              // const locations = [];

              // //adding our locations from the markers on the map
              // for (const marker of markers) {
              //   locations.push(marker);
              // }

              // console.log(locations);
              getRoute();
            })
            .catch((err) => console.log(err));
        });

      // let Object;

      // function createObject() {

      //   var requestOptions = {
      //     method: "POST",
      //     headers: {"Content-Type": "application/json"},
      //     body: JSON.stringify({
      //       name: "Truck 1",
      //       properties: {
      //         driver: "John Doe",
      //       },
      //     }),
      //     redirect: "follow",
      //   };

      //   fetch(
      //     "https://api.tomtom.com/locationHistory/1/objects/object?adminKey=85f9788d-eb57-4843-9961-13c3e7dddb14&key=gBuQtiHC80qAV541N23tKQYRUtZbAKIH",
      //     requestOptions
      //   )
      //     .then((response) => response.text())
      //     .then((result) => {
      //       Object = result;
      //       console.log(result);
      //     })
      //     .catch((error) => console.log("error", error));
      // }

      // createObject()

      // function getFences() {
      //   return fetch(
      //     `https://api.tomtom.com/geofencing/1/projects/${geofencingProjectId}/fences?key=${apiKey}`
      //   )
      //     .then(function (response) {
      //       return response.data.fences;
      //     })
      //     .catch(function (err) {
      //       console.log(err);
      //     });
      // }

      // function displayFence(data) {
      //   const polygon = new Polygon(data).addTo(map);
      // }

      // window.addEventListener("DOMContentLoaded", () => {
      //   getFences()
      //     .then(function (fences) {
      //       return Promise.all(
      //         fences.map(function (fence) {
      //           return getFenceDetails(fence);
      //         })
      //       );
      //     })
      //     .then(function (fences) {
      //       const transformedFences = [];
      //       fences.forEach(function (fence) {
      //         fence = transformFenceToGeoJson(fence);
      //         transformedFences.push(fence);
      //         displayFence(fence);
      //       });
      //       const geoJson = turf.featureCollection(transformedFences);
      //       const bounds = getBounds(geoJson);
      //       map.fitBounds(bounds, {
      //         padding: { top: 15, bottom: 15, left: 15, right: 15 },
      //         animate: false,
      //       });
      //     });
      // });
    </script>
  </body>
</html>
